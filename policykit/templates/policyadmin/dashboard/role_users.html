{% extends "./dashboard_base.html" %}
{% load static %}
{% load slippers %}
{% block styles %}
  <style>
  .body {
    display: flex;
    flex-direction: column;
  }

  .headerText {
    font-family: 'Nunito', sans-serif;
    font-size: 2em;
  }

  .form-row {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }

  .control-label {
    font-family: 'Nunito', sans-serif;
    font-size: 1.2em;
    padding-top: 0.2em;
  }

  .btn#submit {
    padding: 0.5em 2vw;
    font-family: 'Nunito', sans-serif;
    font-size: 1.2em;
    background-color: #4451b2;
    color: #ffffff;
  }

  .btn#submit:hover {
    background-color: #3b4699;
    color: #ffffff;
  }

  button.btn.dropdown-toggle {
      border: 1px solid black;
  }
  </style>
{% endblock %}
{% block content %}
  {% include "patterns/components/headers/page.html" with title="Members" border="true" %}
  <form  hx-target="#message" x-data="members">
    {% csrf_token %}
    <input x-model="operation" name="operation" hidden />
    <div class="table-container">
      <table class="table max-w-4xl">
        <thead>
          <tr>
            <th>
              <label class="flex items-center gap-4 cursor-pointer px-4 py-2 checkbox-label"
                     @click="handleSelectAll">
                <input type="checkbox" id="select-all-checkbox" class="cursor-pointer" />
                <svg width="16"
                     height="16"
                     viewBox="0 0 16 16"
                     fill="none"
                     xmlns="http://www.w3.org/2000/svg"
                     aria-hidden="true"
                     focusable="false"
                     class="checkbox">
                  <rect x="0.5" y="0.5" width="15" height="15" rx="1.5" class="checkbox-bg" />
                  <path d="M3.19995 8.00016L6.39995 10.6668L12.8 5.3335" stroke="white" />
                </svg>
              </label>
            </th>
            <th class="w-2/3">Name</th>
            <th>Role</th>
          </tr>
        </thead>
        <tbody>
          {% for app_name, user_list in users %}
            {% for user in user_list %}
              <tr>
                <th class="w-4">
                  <label class="flex items-center gap-4 cursor-pointer px-4 py-2 checkbox-label">
                    <input type="checkbox"
                           class="member-checkbox cursor-pointer"
                           name="user"
                           value="{{ user.id }}"
                           x-model="selectedUsers" />
                    <svg width="16"
                         height="16"
                         viewBox="0 0 16 16"
                         fill="none"
                         xmlns="http://www.w3.org/2000/svg"
                         aria-hidden="true"
                         focusable="false"
                         class="checkbox">
                      <rect x="0.5" y="0.5" width="15" height="15" rx="1.5" class="checkbox-bg" />
                      <path d="M3.19995 8.00016L6.39995 10.6668L12.8 5.3335" stroke="white" />
                    </svg>
                  </label>
                </th>
                <th class="flex items-center gap-4">
                  <img class="rounded-full h-8 w-8 bg-primary-light" height="32" width="32" src={{ member.avatar }} alt="" />
                  <span>{{ user.readable_name|default_if_none:user.username }}</span>
                </th>
                <th>
                  Role
                </th>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div x-cloak
         x-show="selectedUsers.length > 0"
         class="fixed w-screen lg:w-[calc(100vw-241px)] bg-white bottom-0 right-0 p-6 lg:px-16 lg:pt-[25.5px] lg:pb-[17.5px] border-t-2 border-background-focus flex justify-between items-center">
      <p class="hidden lg:block">
        <span x-text="selectedUsers.length"></span> selected
      </p>
      <div
           class="flex items-center gap-4">
        <button @click="assignModal = true, operation = 'assign'"
          type="button"
          class="button large primary block w-fit ml-auto mr-0">
          <span x-cloak x-show="selectedUsers.length == 1">
            Assign Role(s)
          </span>
          <span x-cloak x-show="selectedUsers.length > 1">
            Bulk-assign
          </span>
        </button>
        <button @click="assignModal = true, operation = 'revoke'" class="button large primary block w-fit ml-auto mr-0">
          <span x-cloak x-show="selectedUsers.length == 1">
            Revoke Role(s)
          </span>
          <span x-cloak x-show="selectedUsers.length > 1">
            Bulk-revoke
          </span>
        </button>
      </div>
      {% #modal data="assignModal" %}
        <div class="px-8 pt-8 pb-6 flex justify-between border-b border-background-focus bg-white sticky top-0">
          <h2 class="p"><span x-text="operation" class="capitalize"></span> role(s)</h2>
          <button x-data @click="assignModal = false">
            <div class="hidden lg:block">{% include "patterns/icons/cancel.html" with class="stroke-grey-darkest" %}</div>
            <div class="lg:hidden">{% include "patterns/icons/nav_arrow_down.html" with class="stroke-grey-darkest" %}</div>
          </button>
        </div>
        <div class="p-8 space-y-4">
          {% for role in roles %}
          <label class="radio-group-item bg-white">
            <div class="flex gap-6 items-start justify-between">
              <div>
                <input type="checkbox" class="sr-only peer" x-modal="roles" name="role" value={{ role.id }} />
                <span class="p large mb-4 block">{{ role }}</span>
                <span class="p text-grey-dark block mb-6">{{ role.description }}</span>
                <span class="peer-checked:hidden text-dark-primary p-2 rounded-[3.5px] inline-block">Select</span>
                <span class="hidden text-dark-primary p-2 bg-success-light text-success-dark rounded-[3.5px] peer-checked:inline-block">Selected</span>
              </div>
            </div>
          </label>
        {% endfor %}
        </div>
        <div class="px-8 pt-8 pb-6 border-t-2 border-background-focus flex items-center justify-end gap-4">
          <button @click="assignModal = false, roles = []" class="button large primary block ">
            Cancel
          </button>
          <button @click="assignModal = true" type="submit" class="button large secondary block capitalize" x-text="operation">
          </button>
        </div>
      {% /modal %}
    </div>
  </form>
  <!-- <div class="body">
    <div class="form-row">
      <div class="col-sm-1"></div>
      <div class="col-sm-11">
        {% if operation == "Add" %}
          <h3 class="headerText">Grant a role to a user</h3>
        {% elif operation == "Remove" %}
          <h3 class="headerText">Revoke a role from a user</h3>
        {% endif %}
      </div>
    </div>
    <div class="form-row">
      <label class="control-label col-sm-1" for="role">Role</label>
      <div class="col-sm-8">
        <select id="rolepicker" class="selectpicker form-control" title="Select role...">
          {% for role in roles %}<option value="{{ role.name }}">{{ role.role_name }}</option>{% endfor %}
        </select>
      </div>
    </div>
    <div class="form-row">
      <label class="control-label col-sm-1" for="user">User</label>
      <div class="col-sm-8">
        <select id="userpicker" class="selectpicker form-control" data-live-search="true" title="Select user...">
          {% for app_name, user_list in users %}
            <optgroup label="{{ app_name|upper }}">
              {% for user in user_list %}
                <option value="{{ user.username }}">{{ user.readable_name|default_if_none:user.username }}</option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="col-sm-1"></div>
      <div class="col-sm-11">
        {% csrf_token %}
        {% if operation == "Add" %}
          <button type="button" class="btn" id="submit">Grant role</button>
        {% elif operation == "Remove" %}
          <button type="button" class="btn" id="submit">Revoke role</button>
        {% endif %}
      </div>
    </div>
  </div> -->
{% endblock %}
{% block scripts %}
  <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('members', () => ({
            selectAll: false,
            assignModal: false,
            selectedUsers: [],
            operation: '',
    
            handleSelectAll() {
                this.selectAll = !this.selectAll

                let checkboxes = document.getElementsByClassName("member-checkbox")
                let allValues = [];

                if (this.selectAll){
                  [...checkboxes].map((el) => {
                  allValues.push(el.value)

                  this.selectedUsers = allValues
                })
                } else {
                  this.selectedUsers = []
                }
                
            }
        }))
    })
  </script>
  <!-- <script>
  document.getElementById('submit').addEventListener("click", submit);
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  function submit() {

    const user = $("#userpicker").val();
    const role = $("#rolepicker").val();

    fetch('../../../main/policyengine/role_operation_users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({
        'role': role,
        'user': user,
        'operation': `{{operation}}`
      })
    }).then(response => {
      if (response.ok) {
        window.location.href = "/main/"
      } else {
        throw Error(response.statusText);
      }
    });
  }
  </script> -->
{% endblock %}
